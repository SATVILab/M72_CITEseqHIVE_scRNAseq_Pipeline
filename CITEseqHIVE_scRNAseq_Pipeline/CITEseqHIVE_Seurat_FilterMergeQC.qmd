---
title: "CITEseqHIVE Seurat Filter, Merge, and QC"
format: html
editor: visual
---

This script uses the unfiltered Seruat object "obj" output by BeeNetPLUS_v2 as input. obj is contained within a .zip .Rdata file found under the following relative path after running BeeNetPLUS_v2 \_\_\_\_\_\_\_\_\_\_. This .Rdata file should be downloaded into a subdirectory called "data/" nested in your working directory. You will also need a subdirectory called "output/" to store results.

### Clear console

```{r, message=FALSE}
ls()
rm(list=ls())
```

### Set output directory

```{r}
dir_save <- "output/"
```

### Load libraries

```{r, message=FALSE}
# CHECK THIS CONTAINS ONLY NECESSARY LIBRARIES
library(SingleCellExperiment)
library(Seurat)
library(SeuratObject)
library(scCustomize)
library(tidyr)
library(dplyr)
library(clustree)
library(ggpubr)
library(patchwork)
library(magrittr)
library(HGNChelper)
library(openxlsx)
library(multtest)
library(metap)
library(ggplot2)
library(gridExtra)
library(cowplot)
```

### Load Seurat objects and perform initial QC and filtering

```{r, warning=FALSE, message=FALSE, results=FALSE}
# Use a loop to load Seurat objects from each BeeNetPLUS_v2 run, visualize raw QC data, filter out low quality cells and merge the filtered data into a new Seurat object.

# Create a list of all files in the "data" subdirectory
directory <- "data"
files <- list.files(directory, full.names = TRUE)

# Filter to keep only the Rdata files
rdata_files <- files[grepl("\\.Rdata$", files)]

# Loop through each Rdata file, load the Seurat object, perform filtering, and merge into a new Seurat object

for (data in rdata_files) {
  # Extract the file names without extension 
  file_name <- tools::file_path_sans_ext(basename(data))
  
  # Load the Seurat object and assign it a unique name using the associated .Rdata file name
  load(data)
  
  # Save the metadata for each run to a .csv with the same file name as the original .Rdata file
  csv_file <- paste0(file_name, "_metadata.csv")
  write.csv(obj@meta.data, file = file.path(dir_save, paste0(csv_file)), row.names = TRUE, quote = FALSE)
  
  # Visualize unfiltered QC metrics
  plot1 <- VlnPlot(obj, features = c("nFeature_RNA", "nCount_RNA", "percent.mito"), ncol = 3, pt.size = 0)
  plot2 <- ggplot(obj@meta.data, aes(x = nCount_RNA)) +
           geom_histogram(bins = 100)
  plot3 <- ggplotGrob(FeatureScatter(obj, feature1 = "nCount_RNA", feature2 = "percent.mito"))
  plot4 <- ggplotGrob(FeatureScatter(obj, feature1 = "nCount_RNA", feature2 = "nFeature_RNA"))
  
  vln_plots <- paste0(file_name, "_QCplots_vln_unfiltered.pdf")
  pdf(paste0(dir_save, vln_plots), height = 5, width = 15)
  print(plot1)
  dev.off()
  
  qc_plots <- paste0(file_name, "_QCplots_unfiltered.pdf")
  pdf(paste0(dir_save, qc_plots), height = 5, width = 15)
  grid.arrange(plot2, plot3, plot4,
               ncol = 3)
  dev.off()
  
  # Filter out cells that have unique feature counts above 2500 or less than 200 and >15% mitochondrial counts

  # The Seurat object "obj" produced by BeeNetPLUS_v2 contains QC metadata based on HTODemux. Cells defined as "Doublet", "Negative", or "LQ" should also be filtered out. 
  obj <- subset(obj, subset = SampleName != "Doublet" & SampleName != "Negative" & SampleName != "LQ")

  # Now apply filters for feature counts and mitochondrial counts
  obj <- subset(obj, subset = nFeature_RNA > 200 & nFeature_RNA < 2500 & percent.mito < 0.15)
  
  # Assign the Seurat object with a unique name using the associated .Rdata file name
  assign(paste0("obj_filtered_", file_name), obj)
    
  }
```

# Merge all filtered Seurat objects

```{r}
# Get all object names in the environment
all_objects <- ls()

# Filter the object names to keep only those starting with "obj_filtered_"
filtered_objects <- all_objects[grep("^obj_filtered_", all_objects)]

# Create a list containing all Seurat objects
list_seurat <- lapply(filtered_objects, get)

# Merge all filtered Seurat objects
obj <- Merge_Seurat_List(list_seurat = list_seurat)

# Split the MULTI_ID column into HIVE, PID, and STIM columns. Do not remove the MULTI_ID column. 
obj@meta.data <- separate(obj@meta.data, MULTI_ID, into = c("HIVE", "PID", "STIM"), sep = "-", remove = FALSE)

# Save filtered Seurat object as new .Rdata file
save(obj, file = "output/FilterMerge_Seurat_obj.Rdata")
```

# Export filtered and merged metadata

```{r}
 write.csv(obj@meta.data, file = file.path(dir_save, "FilterMerge_metadata.csv"), row.names = TRUE, quote = FALSE)
```

# Visualize filtered QC metrics

```{r}
# Visualize the filtered QC metrics
plot1 <- VlnPlot(obj, features = c("nFeature_RNA", "nCount_RNA", "percent.mito"), ncol = 3, pt.size = 0)
plot2 <- ggplot(obj@meta.data, aes(x = nCount_RNA)) +
         geom_histogram(bins = 100)
plot3 <- ggplotGrob(FeatureScatter(obj, feature1 = "nCount_RNA", feature2 = "percent.mito"))
plot4 <- ggplotGrob(FeatureScatter(obj, feature1 = "nCount_RNA", feature2 = "nFeature_RNA"))

vln_plots <- paste0("QCplots_vln_FilterMerge.pdf")
pdf(paste0(dir_save, vln_plots), height = 5, width = 15)
print(plot1)
dev.off()

qc_plots <- paste0("QCplots_FilterMerge.pdf")
pdf(paste0(dir_save, qc_plots), height = 5, width = 15)
grid.arrange(plot2, plot3, plot4,
             ncol = 3)
dev.off()

# Plot reads per cell for each sample
reads_per_cell <- paste0("QCplots_ReadsPerCell_FilterMerge.pdf")
pdf(paste0(dir_save, reads_per_cell), height = 15, width = 15)
ggplot(obj@meta.data, aes(x = nCount_RNA, fill = SampleName)) +
  geom_histogram(bins = 30, alpha = 0.6) +
  scale_x_log10() +
  theme_minimal() +
  labs(title = "Reads Per Cell for Each Sample",
       x = "Reads per Cell (log scale)",
       y = "Frequency",
       fill = "Sample") +
  facet_wrap(~SampleName, scales = "free_y")
dev.off()

# Plot reads per cell as smooth density line
plot5 <- 
  obj[[]] %>% 
  ggplot(aes(x = nCount_RNA + 1)) + 
  geom_density(color = "gray80", linetype = 2, linewidth = 1.5) + 
  geom_density(aes(color = SampleName)) +
  scale_x_log10() +
  theme_bw()

density_plot <- paste0("QCplots_density_FilterMerge.pdf")
pdf(paste0(dir_save, density_plot), height = 5, width = 15)
plot5
dev.off()

```
